{% load static %}
<!doctype html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" herf="{% static 'css/smcebi.css' %}">
        <link rel="stylesheet" href="{% static 'css/leaflet.css' %}">
        <link rel="stylesheet" href="{% static 'css/leaflet-search.css' %}">
        <link rel="stylesheet" href="{% static 'css/qgis2web.css' %}">
        <style>
            html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }</style>
        <title>{{ title }}</title>
    </head>

    <body>
        {% block content %}
            {% block navbar %}
                {% include 'navbar.html' %}
            {% endblock navbar %}

        <div id="map"> </div>
        <script src="{% static 'js/leaflet.js' %}"></script>
        <script src="{% static 'js/leaflet.rotatedMarker.js' %}"></script>
        <script src="{% static 'js/leaflet.pattern.js' %}"></script>
        <script src="{% static 'js/leaflet-hash.js' %}"></script>
        <script src="{% static 'js/Autolinker.min.js' %}"></script>
        <script src="{% static 'js/rbush.min.js' %}"></script>
        <script src="{% static 'js/labelgun.min.js' %}"></script>
        <script src="{% static 'js/labels.js' %}"></script>
        <script src="{% static 'js/leaflet-search.js' %}"></script>
        <script src="{% static 'js/custom-leaflet.js' %}"></script>
        <script type='text/javascript' src='http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster.js'></script>
        <script src="{% static "" %}data/{{ folder_name }}/baselayer.js"></script>
        <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
        <script>
            var highlightLayer;
            function highlightFeature(e) {
                highlightLayer = e.target;
                if (e.target.feature.geometry.type === 'Polygon') {
                highlightLayer.setStyle({
                    weight: 3,
                    color: '#123',
                    fillOpacity: '0.5',
                })
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    highlightLayer.bringToFront();
                }
            }}


        // Styling employees
        // It should be placed inside leaflet-custom.js
        // but for now I've no idea how to read
        // image from js, nothing I've tried so far seems to work.
        var femaleIcon = L.icon({
            iconUrl: "{% static 'markers/female_icon.png' %}",
            iconSize: [20.0, 20.0]
        })

        var maleIcon = L.icon({
            iconUrl: "{% static 'markers/male_icon.png' %}",
            iconSize: [20.0, 20.0]
        })

        function set_marker(feature, latlng) {
            console.log('Setting marker', feature)
            switch (feature.properties.sex) {
                case 'M':
                    return L.marker(latlng, {'icon': maleIcon})
                    break;
                case 'F':
                    return L.marker(latlng, {'icon': femaleIcon})
                    break
            }
        };

        // Map initialization
        var x1y1, x1y2, x2y1, x2y2;
        x1y1 = parseFloat("{{ x1y1 }}");
        x1y2 = parseFloat("{{ x1y2 }}");
        x2y1 = parseFloat("{{ x2y1 }}");
        x2y2 = parseFloat("{{ x2y2 }}");
        var map = L.map('map', {
            zoomControl:true,
            maxZoom:16,
            minZoom:14,
        }).fitBounds([
            [x1y1, x1y2],
            [x2y1, x2y2]])
        // Adding preloaded baselayer from js file
        map.createPane('pane_baselayer');
        map.getPane('pane_baselayer').style.zIndex = 400;
        map.getPane('pane_baselayer').style['mix-blend-mode'] = 'normal';
        var layer_baselayer = new L.GeoJSON(json_baselayer, {
            attribution: "<a href=''/>",
            pane: 'pane_baselayer',
            style: style_baselayer,
        });
        var layersLoaded = {};
        layersLoaded['Baselayer'] = layer_baselayer
        layer_baselayer.addTo(map);

        var control = new L.control.layers({'Baselayer': layer_baselayer})
        control.addTo(map);


    function addOverlay(url, name, opts, map) {
        $.getJSON(url, function(data) {
            layer = new L.GeoJSON(data, opts);
            layersLoaded[name] = layer;
            layer.addTo(map);
            control.addOverlay(layer, name);
        })
    }

    // Create panes
    map.createPane('pane_employees');
    map.getPane('pane_employees').style.zIndex = 402;
    map.getPane('pane_employees').style['mix-blend-mode'] = 'normal';
    map.createPane('pane_rooms');
    map.getPane('pane_rooms').style.zIndex = 401;
    map.getPane('pane_rooms').style['mix-blend-mode'] = 'normal';

    // Create employees opts
    var get_employees_url = '{% url ""|add:emps_data_url floor=floor_no %}';
    emp_opts = {
        onEachFeature: pop_employees,
        pointToLayer: set_marker,
        pane: 'pane_employees',
    }
    // Create rooms opts
    var get_rooms_url = '{% url ""|add:room_data_url floor=floor_no %}';
    rooms_opts = {
        onEachFeature: pop_rooms,
        style: style_rooms,
        pane: 'pane_rooms',
    };

    addOverlay(get_employees_url, 'employees', emp_opts, map)
    addOverlay(get_rooms_url, 'rooms', rooms_opts, map)


</script>
    <script>
        map.attributionControl.addAttribution('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a>');
        // Create legend part
        var baseMaps = {};
        // L.control.layers({}, {'<img src={% static  "legend/baselayer.png"%} /> employees': layer_employees}).addTo(map);
        // L.control.layers(baseMaps,{'<img src={% static  "legend/employee.png"%} /> employees': layer_employees,'<img src="legend/baselayer_1.png" /> baselayer': layer_baselayer,'<img src="legend/rooms_0.png" /> rooms': layer_rooms}).addTo(map);
        </script>
{% endblock content %}
    </body>
</html>
