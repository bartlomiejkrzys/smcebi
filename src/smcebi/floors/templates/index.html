{% load static %}
<!doctype html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes"> -->
        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
{% block css %}
        <link rel="stylesheet" herf="{% static 'css/smcebi.css' %}">
        <link rel="stylesheet" href="{% static 'css/leaflet.css' %}">
        <link rel="stylesheet" href="{% static 'css/leaflet-search.css' %}">
        <link rel="stylesheet" href="{% static 'css/qgis2web.css' %}">
        <style>
            html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }</style>
{% endblock css %}
        <title>{{ title }}</title>
    </head>
{% block content %}
    <body>

        {% block navbar %}
            {% include 'navbar.html' %}
        {% endblock navbar %}
        <script>
        L_PREFER_CANVAS=true
        </script>
        MAMY TUTAJ FOLDER {{ folder_name }}
        <div id="map"> </div>
        <script src="{% static 'js/qgis2web_expressions.js' %}"></script>
        <script src="{% static 'js/leaflet.js' %}"></script>
        <script src="{% static 'js/leaflet.rotatedMarker.js' %}"></script>
        <script src="{% static 'js/leaflet.pattern.js' %}"></script>
        <script src="{% static 'js/leaflet-hash.js' %}"></script>
        <script src="{% static 'js/Autolinker.min.js' %}"></script>
        <script src="{% static 'js/rbush.min.js' %}"></script>
        <script src="{% static 'js/labelgun.min.js' %}"></script>
        <script src="{% static 'js/labels.js' %}"></script>
        <script src="{% static 'js/leaflet-search.js' %}"></script>
        {% block data %}
        <h1>LOADING INDEX DATA</h1>
        <script src="{% static "" %}data/{{ folder_name }}/baselayer.js"></script>
        <script src="{% static "" %}data/{{ folder_name }}/employees.js"></script>
        <!-- <script src="{% static 'data/{{ folder_name }}/employees.js' %}"></script> -->
        {% endblock data %}
        <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
        <script>
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;
            console.log('FEATURE', e);
            if (e.target.feature.geometry.type === 'Polygon') {
                console.log("TAK, POKOJ!")
              highlightLayer.setStyle({
                weight: 3,
                color: '#123',
                fillOpacity: '0.5',
              })
        }}
        </script>
        THIS IS INSIDE INDEX HTML
        {% block map_init %}
        <script>
            var x1y1, x1y2, x2y1, x2y2;
            x1y1 = parseFloat("{{ x1y1 }}");
            x1y2 = parseFloat("{{ x1y2 }}");
            x2y1 = parseFloat("{{ x2y1 }}");
            x2y2 = parseFloat("{{ x2y2 }}");
            console.log(x1y1, x1y2, x2y1, x2y2);
            var map = L.map('map', {
                zoomControl:true,
                maxZoom:16,
                minZoom:13,
            }).fitBounds(
                    [
                            [x1y1, x1y2],
                            [x2y1, x2y2]
                    ]
            )
            var bounds_group = new L.featureGroup([]);
            var loaded_rooms;
            // Load rooms
            var url = '{% url ""|add:room_data %}';
            fetch(url)
                .then(function(resp) {
                    return resp.json()})
                .then(function(geoJSON_data) {
                    map.createPane('pane_rooms')
                    map.getPane('pane_rooms').style.zIndex = 401;
                    map.getPane('pane_rooms').style['mix-blend-mode'] = 'normal';
                    console.log('Gor ROOM data', geoJSON_data);
                    var layer = new L.geoJson(geoJSON_data, {
                        onEachFeature: pop_rooms,
                        style: style_rooms,
                        pane: 'pane_rooms'
                    })
                    loaded_rooms = layer;
                    layer.addTo(map);
                    bounds_group.addLayer(layer)
                });


        </script>
        {% endblock map_init %}
        <script>
        function setBounds() {

        }
        map.addControl(new L.Control.Fullscreen());
        var hash = new L.Hash(map);
        map.attributionControl.addAttribution('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a>');

        {% block room_layer %}


            {% block room_pop %}
                function pop_rooms(feature, layer) {
                    layer.on({
                        mouseout: function(e) {
                            for (i in e.target._eventParents) {
                                e.target._eventParents[i].resetStyle(e.target);
                            }
                        },
                        mouseover: highlightFeature,
                    });
                    console.log('Attachinc popupContent to F', feature);
                    // var popupContent = '<table>\
                    //         <tr>\
                    //             <th scope="row">Wing</th>\
                    //             <td>' + (feature.properties['Wing'] !== null ? Autolinker.link(String(feature.properties['Wing'])) : '') + '</td>\
                    //         </tr>\
                    //         <tr>\
                    //             <th scope="row">Symbol</th>\
                    //             <td>' + (feature.properties['Symbol'] !== null ? Autolinker.link(String(feature.properties['Symbol'])) : '') + '</td>\
                    //         </tr>\
                    //         <tr>\
                    //             <th scope="row">Type</th>\
                    //             <td>' + (feature.properties['Type'] !== null ? Autolinker.link(String(feature.properties['Type'])) : '') + '</td>\
                    //         </tr>\
                    //         <tr>\
                    //             <th scope="row">Floor</th>\
                    //             <td>' + (feature.properties['Floor'] !== null ? Autolinker.link(String(feature.properties['Floor'])) : '') + '</td>\
                    //         </tr>\
                    //         <tr>\
                    //             <th scope="row">Name</th>\
                    //             <td>' + (feature.properties['Name'] !== null ? Autolinker.link(String(feature.properties['Name'])) : '') + '</td>\
                    //         </tr>\
                    //     </table>';
                    popupContent = feature.properties.popupContent;
                    layer.bindPopup(popupContent, {maxHeight: 400});
                };
            // End of room_pop block
            {% endblock room_pop %}


            {% block room_style %}
                function style_rooms(feature) {
                    return {
                                pane: 'pane_rooms',
                                opacity: 1,
                                color: 'rgba(0,0,0,1.0)',
                                lineCap: 'butt',
                                lineJoin: 'miter',
                                weight: 1.0,
                                fill: true,
                                fillOpacity: 1,
                                fillColor: feature.properties.color
                    };
                };
            // End of room_style block
            {% endblock room_style %}

        // map.createPane('pane_rooms');
        // map.getPane('pane_rooms').style.zIndex = 400;
        // map.getPane('pane_rooms').style['mix-blend-mode'] = 'normal';
        // var layer_rooms = new L.geoJson(json_rooms, {
        //     attribution: '<a href=""></a>',
        //     pane: 'pane_rooms',
        //     onEachFeature: pop_rooms,
        //     style: style_rooms,
        // });
        // bounds_group.addLayer(layer_rooms);
        // map.addLayer(layer_rooms);

    // End of room_layer block
    {% endblock room_layer %}


    {% block baselayer %}

        function style_baselayer() {
            return {
                pane: 'pane_baselayer',
                opacity: 1,
                color: 'rgba(80,80,80,1.0)',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 1,
            }
        }
        map.createPane('pane_baselayer');
        map.getPane('pane_baselayer').style.zIndex = 400;
        map.getPane('pane_baselayer').style['mix-blend-mode'] = 'normal';
        var layer_baselayer = new L.geoJson(json_baselayer, {
            attribution: '<a href=""></a>',
            pane: 'pane_baselayer',
            style: style_baselayer,
        });
        bounds_group.addLayer(layer_baselayer);
        map.addLayer(layer_baselayer);
    // End of baselayer block
    {% endblock baselayer %}

    {% block employee_layer %}
        {% block employee_pop %}
            function pop_employees_2(feature, layer) {
                layer.on({
                    mouseout: function(e) {
                        for (i in e.target._eventParents) {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    },
                    mouseover: highlightFeature,
                });
                // var popupContent = '<table>\
                //         <tr>\
                //             <th scope="row">Name</th>\
                //             <td>' + (feature.properties['Name'] !== null ? Autolinker.link(String(feature.properties['Name'])) : '') + '</td>\
                //         </tr>\
                //         <tr>\
                //             <th scope="row">Surname</th>\
                //             <td>' + (feature.properties['Surname'] !== null ? Autolinker.link(String(feature.properties['Surname'])) : '') + '</td>\
                //         </tr>\
                //         <tr>\
                //             <th scope="row">Degree</th>\
                //             <td>' + (feature.properties['Degree'] !== null ? Autolinker.link(String(feature.properties['Degree'])) : '') + '</td>\
                //         </tr>\
                //         <tr>\
                //             <th scope="row">Position</th>\
                //             <td>' + (feature.properties['Position'] !== null ? Autolinker.link(String(feature.properties['Position'])) : '') + '</td>\
                //         </tr>\
                //         <tr>\
                //             <th scope="row">Email</th>\
                //             <td>' + (feature.properties['Email'] !== null ? Autolinker.link(String(feature.properties['Email'])) : '') + '</td>\
                //         </tr>\
                //         <tr>\
                //             <th scope="row">Url</th>\
                //             <td>' + (feature.properties['Url'] !== null ? Autolinker.link(String(feature.properties['Url'])) : '') + '</td>\
                //         </tr>\
                //         <tr>\
                //             <td colspan="2">' + (feature.properties['Phone'] !== null ? Autolinker.link(String(feature.properties['Phone'])) : '') + '</td>\
                //         </tr>\
                //     </table>';
                popupContent = feature.properties.popupContent;
                layer.bindPopup(popupContent, {maxHeight: 400});
            }
        {% endblock employee_pop %}

        {% block employee_style %}
            function style_employees() {
                return {
                    pane: 'pane_employees',
                    radius: 4.0,
                    opacity: 1,
                    color: 'rgba(0,0,0,1.0)',
                    dashArray: '',
                    lineCap: 'butt',
                    lineJoin: 'miter',
                    weight: 1,
                    fill: true,
                    fillOpacity: 1,
                    fillColor: 'rgba(24,218,176,1.0)',
                }
            }

        {% endblock employee_style %}

            map.createPane('pane_employees');
            map.getPane('pane_employees').style.zIndex = 402;
            map.getPane('pane_employees').style['mix-blend-mode'] = 'normal';
            var layer_employees_2 = new L.geoJson(json_employees, {
                attribution: '<a href=""></a>',
                pane: 'pane_employees',
                onEachFeature: pop_employees_2,
                pointToLayer: function (feature, latlng) {
                    var context = {
                        feature: feature,
                        variables: {}
                    };
                    return L.circleMarker(latlng, style_employees(feature));
                },
            });
            bounds_group.addLayer(layer_employees_2);
            map.addLayer(layer_employees_2);

        {% endblock employee_layer %}


        // Create legend part
        var baseMaps = {};
        L.control.layers(baseMaps,{'<img src="legend/employees_2.png" /> employees': layer_employees_2,'<img src="legend/baselayer_1.png" /> baselayer': layer_baselayer,'<img src="legend/rooms_0.png" /> rooms': layer_rooms,}).addTo(map);

        // Add search by room
        map.addControl(new L.Control.Search({
            layer: layer_rooms,
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'Symbol',
            container: 'search'
        }));
        </script>
{% endblock content %}
    </body>
</html>
